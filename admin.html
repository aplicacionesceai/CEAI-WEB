<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - CEAI SENA</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Estilos CEAI -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            background-color: var(--ceai-azul);
            color: white;
            min-height: 100vh;
            padding: 20px;
            position: sticky;
            top: 0;
        }

        .sidebar h5 {
            color: var(--ceai-verde);
            margin-bottom: 20px;
        }

        .sidebar-link {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 6px;
            padding: 10px 15px;
            transition: all 0.3s;
            display: block;
            text-decoration: none;
            font-weight: 500;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background-color: var(--ceai-verde);
            color: white;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .table-responsive {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        #detalleMensaje {
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            max-height: 260px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <script>
        if (localStorage.getItem('ceai_admin_logged') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <div class="container-fluid">
        <div class="row g-0">
            <!-- SIDEBAR -->
            <div class="col-md-3 sidebar">
                <h4 class="fw-bold mb-4">
                    <span style="color: var(--ceai-verde);">CEAI</span> Admin
                </h4>
                
                <h5>üìã Men√∫</h5>
                <div class="sidebar-link active" data-section="dashboard">üìä Dashboard</div>
                <div class="sidebar-link" data-section="noticias">üì∞ Noticias</div>
                <div class="sidebar-link" data-section="semilleros">üå± Semilleros</div>
                <div class="sidebar-link" data-section="proyectos">üî¨ Proyectos</div>
                <div class="sidebar-link" data-section="documentos">üìÑ Documentos</div>
                <div class="sidebar-link" data-section="contactos">üì® Contactos</div>
                
                <hr class="bg-white mt-5 mb-3">
                <button class="btn btn-outline-light btn-sm w-100 mb-2"
                        onclick="localStorage.removeItem('ceai_admin_logged'); window.location.href='login.html';">
                    Cerrar sesi√≥n
                </button>
                <a href="index.html" class="btn btn-outline-light btn-sm w-100">‚Üê Volver al sitio</a>
            </div>

            <!-- CONTENIDO -->
            <div class="col-md-9 p-4">

                <!-- DASHBOARD -->
                <div id="dashboard" class="content-section active">
                    <h2 class="mb-4">üìä Dashboard</h2>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">üì∞ Noticias</h5>
                                    <h3 id="countNoticias" class="text-ceai-verde">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">üå± Semilleros</h5>
                                    <h3 id="countSemilleros" class="text-ceai-verde">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">üî¨ Proyectos</h5>
                                    <h3 id="countProyectos" class="text-ceai-verde">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">üìÑ Documentos</h5>
                                    <h3 id="countDocumentos" class="text-ceai-verde">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title">üì® Contactos</h5>
                                    <h3 id="countContactos" class="text-ceai-verde">0</h3>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-9 mb-3">
                            <div class="card">
                                <div class="card-body d-flex flex-wrap gap-2 align-items-center">
                                    <h5 class="card-title mb-0 me-3">‚ö° Acciones r√°pidas</h5>
                                    <button class="btn btn-ceai btn-sm" onclick="irSeccion('noticias')">Nueva noticia</button>
                                    <button class="btn btn-ceai btn-sm" onclick="irSeccion('semilleros')">Nuevo semillero</button>
                                    <button class="btn btn-ceai btn-sm" onclick="irSeccion('proyectos')">Nuevo proyecto</button>
                                    <button class="btn btn-ceai btn-sm" onclick="irSeccion('documentos')">Subir documento</button>
                                    <button class="btn btn-ceai btn-sm" onclick="irSeccion('contactos')">Contacto</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficos -->
                    <div class="row mt-4">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Contenido por tipo</h5>
                                    <canvas id="chartContenido"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Mensajes de contacto por d√≠a</h5>
                                    <canvas id="chartContactos"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- √öltimos registros -->
                    <div class="row mt-2">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">√öltimas noticias</h5>
                                    <ul id="ultimasNoticias" class="list-group list-group-flush small"></ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">√öltimos contactos</h5>
                                    <ul id="ultimosContactos" class="list-group list-group-flush small"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NOTICIAS -->
                <div id="noticias" class="content-section">
                    <h2 class="mb-4">üì∞ Gestionar Noticias</h2>
                    
                    <div class="form-section">
                        <h5>Nueva Noticia</h5>
                        <form id="formNoticia">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">T√≠tulo</label>
                                    <input type="text" class="form-control" id="noticiaTitulo" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Fecha</label>
                                    <input type="date" class="form-control" id="noticiaFecha" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-control" id="noticiaTipo" required>
                                        <option value="Noticia">Noticia</option>
                                        <option value="Evento">Evento</option>
                                        <option value="Convocatoria">Convocatoria</option>
                                        <option value="Resultado">Resultado</option>
                                    </select>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Descripci√≥n</label>
                                    <textarea class="form-control" id="noticiaDescripcion" rows="3" required></textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">URL Imagen</label>
                                    <input type="url" class="form-control" id="noticiaImagen" placeholder="https://...">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="noticiaDestacada">
                                        <label class="form-check-label" for="noticiaDestacada">
                                            ‚≠ê Destacar en carousel del home
                                        </label>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <button type="submit" class="btn btn-ceai w-100">Crear Noticia</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <h5 class="mb-3">Noticias Existentes</h5>
                        <div id="listaNoticias"></div>
                    </div>
                </div>

                <!-- SEMILLEROS -->
                <div id="semilleros" class="content-section">
                    <h2 class="mb-4">üå± Gestionar Semilleros</h2>
                    
                    <div class="form-section">
                        <h5>Nuevo Semillero</h5>
                        <form id="formSemillero">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="semilleroNombre" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">L√≠nea de Investigaci√≥n</label>
                                    <input type="text" class="form-control" id="semilleroLinea" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Enfoque</label>
                                    <input type="text" class="form-control" id="semilleroEnfoque" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">URL Imagen</label>
                                    <input type="url" class="form-control" id="semilleroImagen" placeholder="https://...">
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Descripci√≥n</label>
                                    <textarea class="form-control" id="semilleroDescripcion" rows="3" required></textarea>
                                </div>
                                <div class="col-12 mb-3">
                                    <button type="submit" class="btn btn-ceai">Crear Semillero</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <h5 class="mb-3">Semilleros Existentes</h5>
                        <div id="listaSemilleros"></div>
                    </div>
                </div>

                <!-- PROYECTOS -->
                <div id="proyectos" class="content-section">
                    <h2 class="mb-4">üî¨ Gestionar Proyectos</h2>
                    
                    <div class="form-section">
                        <h5>Nuevo Proyecto</h5>
                        <form id="formProyecto">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Semillero</label>
                                    <select class="form-control" id="proyectoSemillero" required>
                                        <option value="">-- Seleccionar --</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">T√≠tulo</label>
                                    <input type="text" class="form-control" id="proyectoTitulo" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Estado</label>
                                    <select class="form-control" id="proyectoEstado" required>
                                        <option value="En ejecuci√≥n">En ejecuci√≥n</option>
                                        <option value="Finalizado">Finalizado</option>
                                        <option value="En revisi√≥n">En revisi√≥n</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Aliados</label>
                                    <input type="text" class="form-control" id="proyectoAliados">
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Objetivo</label>
                                    <textarea class="form-control" id="proyectoObjetivo" rows="2"></textarea>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Entregables</label>
                                    <textarea class="form-control" id="proyectoEntregables" rows="2"></textarea>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Evidencia</label>
                                    <textarea class="form-control" id="proyectoEvidencia" rows="2"></textarea>
                                </div>
                                <div class="col-12 mb-3">
                                    <button type="submit" class="btn btn-ceai">Crear Proyecto</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <h5 class="mb-3">Proyectos Existentes</h5>
                        <div id="listaProyectos"></div>
                    </div>
                </div>

                <!-- DOCUMENTOS -->
                <div id="documentos" class="content-section">
                    <h2 class="mb-4">üìÑ Gestionar Documentos</h2>
                    
                    <div class="form-section">
                        <h5>Nuevo Documento</h5>
                        <form id="formDocumento" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nombre del Documento</label>
                                    <input type="text" class="form-control" id="docNombre" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-control" id="docTipo" required>
                                        <option value="">-- Seleccionar --</option>
                                        <option value="Convocatoria">Convocatoria</option>
                                        <option value="Portafolio">Portafolio de Servicios</option>
                                        <option value="Informe">Informe</option>
                                        <option value="Manual">Manual</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Descripci√≥n</label>
                                    <textarea class="form-control" id="docDescripcion" rows="2"></textarea>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Archivo PDF</label>
                                    <div id="dropZone" class="border-2 border-dashed rounded p-5 text-center" style="border: 2px dashed var(--ceai-verde); cursor: pointer; transition: all 0.3s;">
                                        <input type="file" id="docArchivo" class="form-control d-none" accept=".pdf" required>
                                        <div id="dropText">
                                            <p style="margin: 0; color: var(--ceai-verde); font-weight: bold;">üìÅ Arrastra tu PDF aqu√≠</p>
                                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">o haz clic para seleccionar</p>
                                        </div>
                                        <div id="fileSelected" style="display: none; color: var(--ceai-verde);">
                                            <p style="margin: 0; font-weight: bold;">‚úÖ Archivo listo:</p>
                                            <p id="fileName" style="margin: 5px 0 0 0;"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <button type="submit" class="btn btn-ceai">Agregar Documento</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <h5 class="mb-3">Documentos Existentes</h5>
                        <div id="listaDocumentos"></div>
                    </div>
                </div>

                <!-- CONTACTOS -->
                <div id="contactos" class="content-section">
                    <h2 class="mb-4">üì® Mensajes de Contacto</h2>
                    
                    <div class="table-responsive">
                        <h5 class="mb-3">Mensajes Recibidos</h5>
                        <div id="listaContactos"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal Detalle Contacto -->
    <div class="modal fade" id="contactoModal" tabindex="-1" aria-labelledby="contactoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="contactoModalLabel">Detalle del Contacto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <dl class="row mb-0">
              <dt class="col-sm-3">Nombre</dt>
              <dd class="col-sm-9" id="detalleNombre"></dd>

              <dt class="col-sm-3">Email</dt>
              <dd class="col-sm-9" id="detalleEmail"></dd>

              <dt class="col-sm-3">Asunto</dt>
              <dd class="col-sm-9" id="detalleAsunto"></dd>

              <dt class="col-sm-3">Fecha</dt>
              <dd class="col-sm-9" id="detalleFecha"></dd>

              <dt class="col-sm-3">Mensaje</dt>
              <dd class="col-sm-9">
                <div id="detalleMensaje" class="border rounded p-2 bg-light"></div>
              </dd>
            </dl>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Toasts -->
    <script src="js/toasts.js"></script>

    <script>
        const API = 'https://ceai-web-production.up.railway.app';
        let chartContenidoRef = null;
        let chartContactosRef = null;
        let contactosCache = [];

        function irSeccion(id) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-section="${id}"]`).classList.add('active');

            if (id === 'noticias') cargarNoticias();
            if (id === 'semilleros') cargarSemilleros();
            if (id === 'proyectos') cargarProyectos();
            if (id === 'documentos') cargarDocumentos();
            if (id === 'contactos') cargarContactos();
            if (id === 'dashboard') cargarDashboard();
        }

        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => irSeccion(link.dataset.section));
        });

        // ============ DASHBOARD ============
        async function cargarDashboard() {
            const noticias   = await fetch(`${API}/noticias`).then(r => r.json());
            const semilleros = await fetch(`${API}/semilleros`).then(r => r.json());
            const proyectos  = await fetch(`${API}/proyectos`).then(r => r.json());
            const documentos = await fetch(`${API}/documentos`).then(r => r.json());
            const contactos  = await fetch(`${API}/contactos`).then(r => r.json());
            
            document.getElementById('countNoticias').textContent   = noticias.length;
            document.getElementById('countSemilleros').textContent = semilleros.length;
            document.getElementById('countProyectos').textContent  = proyectos.length;
            document.getElementById('countDocumentos').textContent = documentos.length;
            document.getElementById('countContactos').textContent  = contactos.length;

            const ctx1 = document.getElementById('chartContenido').getContext('2d');
            if (chartContenidoRef) chartContenidoRef.destroy();

            chartContenidoRef = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Noticias', 'Semilleros', 'Proyectos', 'Documentos'],
                    datasets: [{
                        data: [noticias.length, semilleros.length, proyectos.length, documentos.length],
                        backgroundColor: ['#39A900', '#2d8a00', '#00304D', '#76c043']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });

            const porDia = {};
            contactos.forEach(c => {
                if (!c.created_at) return;
                const d = new Date(c.created_at);
                const key = d.toLocaleDateString('es-ES');
                porDia[key] = (porDia[key] || 0) + 1;
            });

            const labels = Object.keys(porDia);
            const valores = Object.values(porDia);

            const ctx2 = document.getElementById('chartContactos').getContext('2d');
            if (chartContactosRef) chartContactosRef.destroy();

            chartContactosRef = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data: valores,
                        borderColor: '#39A900',
                        backgroundColor: 'rgba(57,169,0,0.2)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });

            const ulNoticias = document.getElementById('ultimasNoticias');
            ulNoticias.innerHTML = noticias
                .slice(-5)
                .reverse()
                .map(n => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${n.titulo}</span>
                        <span class="text-muted ms-2">${n.fecha}</span>
                    </li>
                `).join('');

            const ulContactos = document.getElementById('ultimosContactos');
            ulContactos.innerHTML = contactos
                .slice(-5)
                .reverse()
                .map(c => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${c.nombre}</span>
                        <span class="text-muted ms-2">
                            ${c.created_at ? new Date(c.created_at).toLocaleDateString('es-ES') : ''}
                        </span>
                    </li>
                `).join('');
        }

        // ============ NOTICIAS ============
        async function cargarNoticias() {
            const response = await fetch(`${API}/noticias`);
            const noticias = await response.json();
            
            const lista = document.getElementById('listaNoticias');
            if (!noticias.length) {
                lista.innerHTML = '<p class="text-muted">No hay noticias a√∫n</p>';
                return;
            }
            
            lista.innerHTML = `
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>T√≠tulo</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Destacada</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${noticias.map(n => `
                            <tr>
                                <td>${n.id}</td>
                                <td>${n.titulo}</td>
                                <td>${n.fecha}</td>
                                <td>${n.tipo || 'Noticia'}</td>
                                <td>${n.destacada === 1 ? '‚≠ê' : ''}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="eliminarNoticia(${n.id})">üóëÔ∏è Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        document.getElementById('formNoticia').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const datos = {
                titulo: document.getElementById('noticiaTitulo').value,
                descripcion: document.getElementById('noticiaDescripcion').value,
                fecha: document.getElementById('noticiaFecha').value,
                imagen: document.getElementById('noticiaImagen').value,
                tipo: document.getElementById('noticiaTipo').value,
                destacada: document.getElementById('noticiaDestacada').checked ? 1 : 0
            };
            
            const response = await fetch(`${API}/noticias`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            
            if (response.ok) {
                toast.success('Noticia creada correctamente');
                document.getElementById('formNoticia').reset();
                cargarNoticias();
                cargarDashboard();
            } else {
                const error = await response.json();
                toast.error('Error al crear noticia: ' + (error.error || ''));
            }
        });

        async function eliminarNoticia(id) {
            if (!confirm('¬øEliminar esta noticia?')) return;
            const res = await fetch(`${API}/noticias/${id}`, { method: 'DELETE' });
            if (res.ok) {
                toast.info('Noticia eliminada');
                cargarNoticias();
                cargarDashboard();
            } else {
                toast.error('Error al eliminar noticia');
            }
        }

        // ============ SEMILLEROS ============
        async function cargarSemilleros() {
            const response = await fetch(`${API}/semilleros`);
            const semilleros = await response.json();
            
            const select = document.getElementById('proyectoSemillero');
            select.innerHTML = '<option value="">-- Seleccionar --</option>' +
                semilleros.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
            
            const lista = document.getElementById('listaSemilleros');
            if (!semilleros.length) {
                lista.innerHTML = '<p class="text-muted">No hay semilleros a√∫n</p>';
                return;
            }
            
            lista.innerHTML = `
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>L√≠nea</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${semilleros.map(s => `
                            <tr>
                                <td>${s.id}</td>
                                <td>${s.nombre}</td>
                                <td>${s.linea}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="eliminarSemillero(${s.id})">üóëÔ∏è Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        document.getElementById('formSemillero').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const datos = {
                nombre: document.getElementById('semilleroNombre').value,
                linea: document.getElementById('semilleroLinea').value,
                enfoque: document.getElementById('semilleroEnfoque').value,
                descripcion: document.getElementById('semilleroDescripcion').value,
                imagen: document.getElementById('semilleroImagen').value
            };
            
            const response = await fetch(`${API}/semilleros`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            
            if (response.ok) {
                toast.success('Semillero creado');
                document.getElementById('formSemillero').reset();
                cargarSemilleros();
                cargarDashboard();
            } else {
                toast.error('Error al crear semillero');
            }
        });

        async function eliminarSemillero(id) {
            if (!confirm('¬øEliminar este semillero?')) return;
            const res = await fetch(`${API}/semilleros/${id}`, { method: 'DELETE' });
            if (res.ok) {
                toast.info('Semillero eliminado');
                cargarSemilleros();
                cargarDashboard();
            } else {
                toast.error('Error al eliminar semillero');
            }
        }

        // ============ PROYECTOS ============
        async function cargarProyectos() {
            const response = await fetch(`${API}/proyectos`);
            const proyectos = await response.json();
            
            const lista = document.getElementById('listaProyectos');
            if (!proyectos.length) {
                lista.innerHTML = '<p class="text-muted">No hay proyectos a√∫n</p>';
                return;
            }
            
            lista.innerHTML = `
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>T√≠tulo</th>
                            <th>Semillero</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${proyectos.map(p => `
                            <tr>
                                <td>${p.id}</td>
                                <td>${p.titulo}</td>
                                <td>${p.semillero_id}</td>
                                <td>
                                    <span class="badge ${
                                        p.estado === 'En ejecuci√≥n'
                                            ? 'bg-primary'
                                            : p.estado === 'Finalizado'
                                            ? 'bg-success'
                                            : 'bg-warning'
                                    }">${p.estado}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="eliminarProyecto(${p.id})">üóëÔ∏è Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        document.getElementById('formProyecto').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const datos = {
                semillero_id: document.getElementById('proyectoSemillero').value,
                titulo: document.getElementById('proyectoTitulo').value,
                estado: document.getElementById('proyectoEstado').value,
                aliados: document.getElementById('proyectoAliados').value,
                objetivo: document.getElementById('proyectoObjetivo').value,
                entregables: document.getElementById('proyectoEntregables').value,
                evidencia: document.getElementById('proyectoEvidencia').value
            };
            
            const response = await fetch(`${API}/proyectos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            
            if (response.ok) {
                toast.success('Proyecto creado');
                document.getElementById('formProyecto').reset();
                cargarProyectos();
                cargarDashboard();
            } else {
                toast.error('Error al crear proyecto');
            }
        });

        async function eliminarProyecto(id) {
            if (!confirm('¬øEliminar este proyecto?')) return;
            const res = await fetch(`${API}/proyectos/${id}`, { method: 'DELETE' });
            if (res.ok) {
                toast.info('Proyecto eliminado');
                cargarProyectos();
                cargarDashboard();
            } else {
                toast.error('Error al eliminar proyecto');
            }
        }

        // ============ DOCUMENTOS ============
        const dropZone = document.getElementById('dropZone');
        const docArchivo = document.getElementById('docArchivo');
        const dropText = document.getElementById('dropText');
        const fileSelected = document.getElementById('fileSelected');
        const fileName = document.getElementById('fileName');

        dropZone.addEventListener('click', () => docArchivo.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = 'rgba(57, 169, 0, 0.1)';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = 'transparent';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = 'transparent';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                docArchivo.files = files;
                actualizarNombreArchivo(files[0]);
            }
        });

        docArchivo.addEventListener('change', () => {
            if (docArchivo.files.length > 0) {
                actualizarNombreArchivo(docArchivo.files[0]);
            }
        });

        function actualizarNombreArchivo(file) {
            if (file.type !== 'application/pdf') {
                toast.warning('Solo se permiten archivos PDF');
                docArchivo.value = '';
                dropText.style.display = 'block';
                fileSelected.style.display = 'none';
                return;
            }
            
            fileName.textContent = file.name;
            dropText.style.display = 'none';
            fileSelected.style.display = 'block';
        }

        async function cargarDocumentos() {
            const response = await fetch(`${API}/documentos`);
            const documentos = await response.json();
            
            const lista = document.getElementById('listaDocumentos');
            if (!documentos.length) {
                lista.innerHTML = '<p class="text-muted">No hay documentos a√∫n</p>';
                return;
            }
            
            lista.innerHTML = `
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Archivo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${documentos.map(doc => `
                            <tr>
                                <td>${doc.id}</td>
                                <td>${doc.nombre}</td>
                                <td><span class="badge bg-info">${doc.tipo}</span></td>
                                <td><a href="${doc.ruta_archivo}" target="_blank" class="text-decoration-none">üì• Descargar</a></td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="eliminarDocumento(${doc.id})">üóëÔ∏è Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        document.getElementById('formDocumento').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!docArchivo.files.length) {
                toast.warning('Por favor selecciona un archivo PDF');
                return;
            }

            const formData = new FormData();
            formData.append('nombre', document.getElementById('docNombre').value);
            formData.append('tipo', document.getElementById('docTipo').value);
            formData.append('descripcion', document.getElementById('docDescripcion').value);
            formData.append('archivo', docArchivo.files[0]);
            
            try {
                const response = await fetch(`${API}/documentos`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    toast.success('Documento agregado');
                    document.getElementById('formDocumento').reset();
                    docArchivo.value = '';
                    dropText.style.display = 'block';
                    fileSelected.style.display = 'none';
                    cargarDocumentos();
                    cargarDashboard();
                } else {
                    const error = await response.json();
                    toast.error('Error al subir documento: ' + (error.error || ''));
                }
            } catch (error) {
                toast.error('Error al subir archivo: ' + error.message);
            }
        });

        async function eliminarDocumento(id) {
            if (!confirm('¬øEliminar este documento?')) return;
            const res = await fetch(`${API}/documentos/${id}`, { method: 'DELETE' });
            if (res.ok) {
                toast.info('Documento eliminado');
                cargarDocumentos();
                cargarDashboard();
            } else {
                toast.error('Error al eliminar documento');
            }
        }

        // ============ CONTACTOS ============
        async function cargarContactos() {
            const response = await fetch(`${API}/contactos`);
            const contactos = await response.json();
            contactosCache = contactos;
            
            const lista = document.getElementById('listaContactos');
            if (!contactos.length) {
                lista.innerHTML = '<p class="text-muted">No hay mensajes a√∫n</p>';
                return;
            }
            
            lista.innerHTML = `
                <table class="table table-hover table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th style="width: 160px;">Nombre</th>
                            <th style="width: 220px;">Email</th>
                            <th style="width: 160px;">Asunto</th>
                            <th>Mensaje</th>
                            <th style="width: 110px;">Fecha</th>
                            <th style="width: 140px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contactos.map(c => `
                            <tr>
                                <td>${c.id}</td>
                                <td>${c.nombre}</td>
                                <td><small>${c.email}</small></td>
                                <td><small>${c.asunto}</small></td>
                                <td style="max-width: 260px;">
                                    <small class="text-muted text-truncate d-inline-block w-100" style="white-space: nowrap;">
                                        ${c.mensaje}
                                    </small>
                                </td>
                                <td><small>${c.created_at ? new Date(c.created_at).toLocaleDateString('es-ES') : ''}</small></td>
                                <td>
                                    <div class="d-flex gap-1 justify-content-end">
                                        <button class="btn btn-sm btn-ceai"
                                            onclick="verContacto(${c.id})">
                                            Ver
                                        </button>
                                        <button class="btn btn-sm btn-danger"
                                            onclick="eliminarContacto(${c.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function eliminarContacto(id) {
            if (!confirm('¬øEliminar este mensaje?')) return;
            const res = await fetch(`${API}/contactos/${id}`, { method: 'DELETE' });
            if (res.ok) {
                toast.info('Mensaje eliminado');
                cargarContactos();
                cargarDashboard();
            } else {
                toast.error('Error al eliminar mensaje');
            }
        }

        function verContacto(id) {
            const c = contactosCache.find(x => x.id === id);
            if (!c) return;

            document.getElementById('detalleNombre').textContent = c.nombre;
            document.getElementById('detalleEmail').textContent = c.email;
            document.getElementById('detalleAsunto').textContent = c.asunto;
            document.getElementById('detalleFecha').textContent =
                c.created_at ? new Date(c.created_at).toLocaleString('es-ES') : '';
            document.getElementById('detalleMensaje').textContent = c.mensaje;

            const modalEl = document.getElementById('contactoModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        // Iniciar
        cargarDashboard();
    </script>
</body>
</html>
